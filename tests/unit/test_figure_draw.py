import json

from shapely.geometry import shape

from geoshiny.types import ExtentDegrees, Geometry2DStyle
from geoshiny.draw_helpers import render_shapes_to_figure, figure_to_numpy

# Geometry types
#  'Point',
#     'LineString',
#     'LinearRing',
#     'Polygon',
#     'MultiPoint',
#     'MultiLineString',
#     'MultiPolygon',
#     'GeometryCollection'


def test_render_polygon(tmpdir):
    # this is a building with many yards, see https://www.openstreetmap.org/relation/56880
    line_geojson = '{"type":"Polygon","coordinates":[[[13.3730741,52.528892399],[13.3732394,52.528739999],[13.3733324,52.528769599],[13.3734522,52.528810199],[13.3736096,52.528858799],[13.3744697,52.529166499],[13.3747036,52.529250199],[13.3748861,52.529311299],[13.3749662,52.529338699],[13.3745283,52.529799099],[13.3742478,52.529694699],[13.374134,52.529808599],[13.3737474,52.529675299],[13.373759,52.529665399],[13.3738839,52.529534099],[13.3736457,52.529450199],[13.3735978,52.529432699],[13.3738416,52.529166699],[13.3730741,52.528892399]],[[13.3733161,52.528932899],[13.3735506,52.529015099],[13.3736102,52.528954699],[13.3733767,52.528872999],[13.3733161,52.528932899]],[[13.3736913,52.529063299],[13.3738527,52.529120799],[13.3739092,52.529059099],[13.3737474,52.529001599],[13.3736913,52.529063299]],[[13.3738146,52.529369699],[13.3738877,52.529395999],[13.373992,52.529289999],[13.3739195,52.529263899],[13.3738146,52.529369699]],[[13.3739585,52.529161699],[13.374125,52.529221599],[13.3741824,52.529159999],[13.3740189,52.529101199],[13.3739585,52.529161699]],[[13.3739754,52.529504299],[13.3742818,52.529615199],[13.3744435,52.529445099],[13.3741371,52.529335599],[13.3739754,52.529504299]],[[13.3742729,52.529277899],[13.3744951,52.529357999],[13.3745516,52.529295799],[13.374334,52.529217499],[13.3742729,52.529277899]],[[13.3744009,52.529653699],[13.3744945,52.529685499],[13.3746104,52.529557999],[13.3745186,52.529527799],[13.3744009,52.529653699]],[[13.374605,52.529450799],[13.3746828,52.529479599],[13.3747424,52.529415999],[13.3746646,52.529386499],[13.374605,52.529450799]]]}'
    multipolygon = shape(json.loads(line_geojson))

    line_geojson2 = '{"type":"Polygon","coordinates":[[[13.370113,52.533598999],[13.3703205,52.533418499],[13.3707833,52.533616299],[13.3709272,52.533677799],[13.3708984,52.533702899],[13.3709142,52.533709099],[13.3708979,52.533723799],[13.3708817,52.533738499],[13.3708656,52.533731399],[13.3708095,52.533780199],[13.3708251,52.533786199],[13.3708121,52.533797699],[13.3707991,52.533809199],[13.3707831,52.533803199],[13.3707214,52.533856899],[13.3701753,52.533625399],[13.370113,52.533598999]],[[13.370314,52.533620999],[13.3703358,52.533630599],[13.3703553,52.533628799],[13.3705487,52.533709399],[13.3705595,52.533735699],[13.3705824,52.533744899],[13.3706001,52.533727299],[13.3705982,52.533722699],[13.3706835,52.533648599],[13.370691,52.533648899],[13.370708,52.533634499],[13.3706765,52.533622099],[13.3706325,52.533628399],[13.3704518,52.533552499],[13.3704478,52.533530099],[13.3704249,52.533521099],[13.370314,52.533620999]]]}'
    multipolygon2 = shape(json.loads(line_geojson2))

    lines_geojson3 = '{"type":"Polygon","coordinates":[[[13.372177,52.528578699],[13.3722708,52.528484999],[13.372197,52.528457599],[13.3723126,52.528342099],[13.372318,52.528336699],[13.372377,52.528358599],[13.3723713,52.528364299],[13.3725852,52.528443499],[13.372711,52.528317799],[13.3726535,52.528296399],[13.3727006,52.528249399],[13.3726909,52.528245799],[13.3727599,52.528176799],[13.372767,52.528179499],[13.373034,52.527912699],[13.3730277,52.527910399],[13.3730982,52.527839999],[13.3732201,52.527885199],[13.3733491,52.527932999],[13.3732799,52.528002099],[13.3732728,52.527999499],[13.3730044,52.528267599],[13.3730124,52.528270599],[13.3729424,52.528340499],[13.3729341,52.528337499],[13.3728883,52.528383299],[13.3728297,52.528361599],[13.3727029,52.528488199],[13.3727133,52.528491999],[13.372505,52.528700199],[13.3723248,52.528633399],[13.3721843,52.528581399],[13.372177,52.528578699]]]}'
    multipolygon3 = shape(json.loads(lines_geojson3))

    # this extent contains the above feature in its North-East corner
    extent = ExtentDegrees(
        latmin=52.5275,
        latmax=52.5356,
        lonmin=13.3613,
        lonmax=13.3768,
    )
    fig = render_shapes_to_figure(
        extent,
        [
            (multipolygon, Geometry2DStyle(facecolor="#ff0000", edgecolor="black", alpha=0.5)),
            (multipolygon2, Geometry2DStyle(facecolor="#00ff00", edgecolor="blue")),
            (multipolygon3, Geometry2DStyle(facecolor="yellow", edgecolor="blue")),
        ],
    )

    for target in ["img.png", "img.svg"]:
        target_file = tmpdir.join(target)
        fig.savefig(str(target_file))
        assert target_file.size() > 4_500

    image_from_plot = figure_to_numpy(fig)
    assert image_from_plot.shape == (1500, 1500, 4)
